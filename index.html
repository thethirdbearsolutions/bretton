<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bretton Woods Conference - Multiplayer (Server)</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="root">
        <div class="container">
            <div class="card">
                <p style="text-align: center; padding: 40px;">Connecting to server...</p>
            </div>
        </div>
    </div>
    
    <!-- Socket.io client -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        // Load game data
        let gameData = null;
        fetch('/game-data.json')
          .then(r => r.json())
          .then(data => {
            gameData = data;
            initializeApp();
          });

        const socket = io();
        const { useState, useEffect } = React;

        const BrettonWoodsMultiplayer = () => {
          const [playerId] = useState(() => {
            let id = sessionStorage.getItem('brettonWoodsPlayerId');
            if (!id) {
              id = `player_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
              sessionStorage.setItem('brettonWoodsPlayerId', id);
            }
            return id;
          });
          
          const [playerCountry, setPlayerCountry] = useState(null);
          const [isReady, setIsReady] = useState(false);
          const [gameStateData, setGameStateData] = useState(null);
          const [showEconomics, setShowEconomics] = useState(false);
          const [connected, setConnected] = useState(false);
          
          // Authentication state
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [username, setUsername] = useState('');
          const [showRegister, setShowRegister] = useState(false);

          // Check for existing session on mount
          useEffect(() => {
            const savedUsername = sessionStorage.getItem('brettonWoodsUsername');
            const savedPlayerId = sessionStorage.getItem('brettonWoodsPlayerId');
            
            if (savedUsername && savedPlayerId) {
              setUsername(savedUsername);
              setIsAuthenticated(true);
            }
          }, []);


          useEffect(() => {
            // Socket event listeners
            socket.on('connect', () => {
              console.log('Connected to server');
              setConnected(true);
            });

            socket.on('disconnect', () => {
              console.log('Disconnected from server');
              setConnected(false);
            });

            socket.on('stateUpdate', (state) => {
              setGameStateData(state);
              const player = state.players[playerId];
              if (player) {
                setPlayerCountry(player.country);
              }
              setIsReady(state.readyPlayers.includes(playerId));
            });

            socket.on('joinResult', (result) => {
              if (!result.success) {
                alert(result.message);
              }
            });

            

            // Authentication result handlers
            socket.on('registerResult', (result) => {
              if (result.success) {
                sessionStorage.setItem('brettonWoodsPlayerId', result.playerId);
                sessionStorage.setItem('brettonWoodsUsername', result.username);
                setUsername(result.username);
                setIsAuthenticated(true);
              } else {
                alert(result.message);
              }
            });

            socket.on('loginResult', (result) => {
              if (result.success) {
                sessionStorage.setItem('brettonWoodsPlayerId', result.playerId);
                sessionStorage.setItem('brettonWoodsUsername', result.username);
                setUsername(result.username);
                setIsAuthenticated(true);
              } else {
                alert(result.message);
              }
            });

            return () => {
              socket.off('connect');
              socket.off('disconnect');
              socket.off('stateUpdate');
              socket.off('joinResult');
              socket.off('registerResult');
              socket.off('loginResult');
            };
          }, [playerId]);

          const joinGame = (country) => {
            socket.emit('joinGame', { playerId, country });
          };

          const leaveGame = () => {
            socket.emit('leaveGame', { playerId });
            setPlayerCountry(null);
          };

          const toggleReady = () => {
            const newReady = !isReady;
            socket.emit('setReady', { playerId, ready: newReady });
          };

          const startGame = () => {
            socket.emit('startGame');
          };

          const submitVote = (issueId, optionId) => {
            socket.emit('submitVote', { playerId, issueId, optionId });
          };

          const advanceRound = () => {
            socket.emit('nextRound');
          };

          const resetGame = () => {
            if (confirm('Are you sure you want to reset the game for all players?')) {
              socket.emit('resetGame');
              setPlayerCountry(null);
            }
          };
          
          const handleAuth = (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const user = formData.get('username');
            const pass = formData.get('password');
            
            if (showRegister) {
              socket.emit('register', { username: user, password: pass });
            } else {
              socket.emit('login', { username: user, password: pass });
            }
          };

          const handleLogout = () => {
            sessionStorage.clear();
            setIsAuthenticated(false);
            setUsername('');
            setPlayerCountry(null);
            window.location.reload();
          };


          
          
          // Username display component
          const UserDisplay = () => (
            <div style={{
              position: 'fixed',
              top: '10px',
              left: '10px',
              padding: '8px 16px',
              background: '#eff6ff',
              color: '#1e40af',
              borderRadius: '6px',
              fontSize: '0.875rem',
              fontWeight: '600',
              zIndex: 1000,
              boxShadow: '0 2px 8px rgba(0,0,0,0.1)'
            }}>
              üë§ {username}
              <button
                onClick={handleLogout}
                style={{
                  marginLeft: '12px',
                  padding: '4px 8px',
                  background: '#dc2626',
                  color: 'white',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  fontSize: '0.75rem'
                }}
              >
                Logout
              </button>
            </div>
          );

          
          
          // Show login screen if not authenticated
          if (!isAuthenticated) {
            return (
              <div className="container">
                <div className="header">
                  <h1>üåç Bretton Woods Conference</h1>
                  <p>Educational Multiplayer Simulation</p>
                </div>
                
                <div className="card" style={{ maxWidth: '400px', margin: '0 auto' }}>
                  <h2 style={{ textAlign: 'center', marginBottom: '30px' }}>
                    {showRegister ? 'Create Account' : 'Login'}
                  </h2>
                  
                  <form onSubmit={handleAuth}>
                    <div style={{ marginBottom: '20px' }}>
                      <label style={{ display: 'block', marginBottom: '8px', fontWeight: 'bold' }}>
                        Username
                      </label>
                      <input
                        type="text"
                        name="username"
                        required
                        minLength="3"
                        style={{
                          width: '100%',
                          padding: '12px',
                          fontSize: '1rem',
                          border: '2px solid #cbd5e1',
                          borderRadius: '6px',
                          boxSizing: 'border-box'
                        }}
                        placeholder="Enter username (min 3 characters)"
                      />
                    </div>
                    
                    <div style={{ marginBottom: '30px' }}>
                      <label style={{ display: 'block', marginBottom: '8px', fontWeight: 'bold' }}>
                        Password
                      </label>
                      <input
                        type="password"
                        name="password"
                        required
                        minLength="4"
                        style={{
                          width: '100%',
                          padding: '12px',
                          fontSize: '1rem',
                          border: '2px solid #cbd5e1',
                          borderRadius: '6px',
                          boxSizing: 'border-box'
                        }}
                        placeholder="Enter password (min 4 characters)"
                      />
                    </div>
                    
                    <button
                      type="submit"
                      className="btn-primary"
                      style={{ width: '100%', padding: '14px', fontSize: '1.125rem', marginBottom: '16px' }}
                    >
                      {showRegister ? 'üìù Create Account' : 'üîì Login'}
                    </button>
                  </form>
                  
                  <div style={{ textAlign: 'center', paddingTop: '20px', borderTop: '1px solid #e2e8f0' }}>
                    <button
                      onClick={() => setShowRegister(!showRegister)}
                      style={{
                        background: 'none',
                        border: 'none',
                        color: '#3b82f6',
                        cursor: 'pointer',
                        fontSize: '0.9rem',
                        textDecoration: 'underline'
                      }}
                    >
                      {showRegister 
                        ? 'Already have an account? Login' 
                        : "Don\'t have an account? Register"}
                    </button>
                  </div>
                  
                  <div style={{ 
                    marginTop: '30px', 
                    padding: '16px', 
                    background: '#f8fafc', 
                    borderRadius: '6px',
                    fontSize: '0.875rem',
                    color: '#64748b'
                  }}>
                    <p style={{ marginBottom: '8px' }}><strong>Note:</strong></p>
                    <ul style={{ marginLeft: '20px' }}>
                      <li>Usernames must be at least 3 characters</li>
                      <li>Passwords must be at least 4 characters</li>
                      <li>Your account persists across games</li>
                    </ul>
                  </div>
                </div>
              </div>
            );
          }

          if (!gameData || !gameStateData) {
            return (
              <div className="container">
                <div className="card">
                  <p style={{ textAlign: 'center', padding: '40px' }}>
                    {!connected ? 'üî¥ Connecting to server...' : '‚öôÔ∏è Loading game data...'}
                  </p>
                </div>
              </div>
            );
          }

          const { countries, economicData, issues } = gameData;
          const currentIssue = issues[gameStateData.currentRound - 1];
          const availableCountries = Object.keys(countries).filter(
            country => !Object.values(gameStateData.players).some(p => p.country === country)
          );

          // Connection status indicator
          const ConnectionStatus = () => (
            <div style={{
              position: 'fixed',
              top: '10px',
              right: '10px',
              padding: '8px 16px',
              background: connected ? '#dcfce7' : '#fee2e2',
              color: connected ? '#166534' : '#991b1b',
              borderRadius: '6px',
              fontSize: '0.875rem',
              fontWeight: '600',
              zIndex: 1000
            }}>
              {connected ? 'üü¢ Connected' : 'üî¥ Disconnected'}
            </div>
          );

          // Lobby Screen
          if (!gameStateData.gameStarted && gameStateData.gamePhase === 'lobby') {
            return (
              <div className="container">
                <UserDisplay />
                <ConnectionStatus />
                <div className="header">
                  <h1>üåç Bretton Woods 1944</h1>
                  <p>Multiplayer Simulation - Lobby</p>
                </div>

                <div className="card">
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '20px' }}>
                    <h2 style={{ fontSize: '1.5rem', color: '#1e293b' }}>Game Lobby</h2>
                    <div style={{ fontSize: '0.875rem', color: '#64748b' }}>
                      Room: {gameStateData.gameId}
                    </div>
                  </div>

                  <div style={{ marginBottom: '30px' }}>
                    <h3 style={{ fontSize: '1.125rem', marginBottom: '16px' }}>
                      üë• Players ({Object.keys(gameStateData.players).length}/5)
                    </h3>
                    
                    <div style={{ display: 'grid', gap: '12px' }}>
                      {Object.entries(gameStateData.players).map(([id, player]) => (
                        <div key={id} style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          padding: '12px',
                          background: id === playerId ? '#eff6ff' : '#f8fafc',
                          borderRadius: '8px',
                          borderLeft: '4px solid ' + (id === playerId ? '#3b82f6' : '#cbd5e1')
                        }}>
                          <div>
                            <span className={countries[player.country].textColor} style={{ fontWeight: 'bold' }}>
                              {countries[player.country].name}
                            </span>
                            {id === playerId && <span style={{ marginLeft: '8px', fontSize: '0.875rem', color: '#3b82f6' }}>(You)</span>}
                          </div>
                          <div>
                            {gameStateData.readyPlayers.includes(id) ? (
                              <span style={{ color: '#16a34a', fontWeight: 'bold' }}>‚úì Ready</span>
                            ) : (
                              <span style={{ color: '#64748b' }}>Not Ready</span>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  {!playerCountry ? (
                    <div>
                      <h3 style={{ fontSize: '1.125rem', marginBottom: '16px' }}>Select Your Nation</h3>
                      <div className="country-grid">
                        {availableCountries.map(key => (
                          <div key={key} className={`country-card ${countries[key].color}`} onClick={() => joinGame(key)}>
                            <h3>{countries[key].name}</h3>
                            <p style={{ fontSize: '0.875rem', marginBottom: '12px', opacity: '0.9' }}>
                              {countries[key].economicPosition}
                            </p>
                            <ul>
                              {countries[key].objectives.slice(0, 2).map((obj, idx) => (
                                <li key={idx}>{obj}</li>
                              ))}
                            </ul>
                          </div>
                        ))}
                      </div>
                    </div>
                  ) : (
                    <div style={{ textAlign: 'center' }}>
                      <div style={{ marginBottom: '20px', padding: '20px', background: '#f8fafc', borderRadius: '8px' }}>
                        <p style={{ color: '#64748b', marginBottom: '8px' }}>You are playing as</p>
                        <h2 className={countries[playerCountry].textColor} style={{ fontSize: '1.75rem' }}>
                          {countries[playerCountry].name}
                        </h2>
                      </div>
                      
                      <div style={{ display: 'flex', gap: '12px', justifyContent: 'center', flexWrap: 'wrap' }}>
                        <button className={isReady ? 'btn-success' : 'btn-primary'} onClick={toggleReady}>
                          {isReady ? '‚úì Ready' : 'Mark Ready'}
                        </button>
                        <button className="btn-secondary" onClick={leaveGame}>‚Üê Leave Game</button>
                        {Object.keys(gameStateData.players).length > 1 && 
                         gameStateData.readyPlayers.length === Object.keys(gameStateData.players).length && (
                          <button className="btn-success" onClick={startGame}>üéÆ Start Conference</button>
                        )}
                      </div>

                      <button className="btn-danger" onClick={resetGame} style={{ marginTop: '20px' }}>
                        üîÑ Reset Game
                      </button>
                    </div>
                  )}
                </div>
              </div>
            );
          }

          // Phase 2: Economic Management
          if (gameStateData.gamePhase === 'phase2' && gameStateData.phase2 && gameStateData.phase2.active) {
            const currentYear = gameStateData.phase2.currentYear;
            const yearlyData = gameStateData.phase2.yearlyData[currentYear];
            const myCountryData = yearlyData ? yearlyData[playerCountry] : null;
            const myPolicies = gameStateData.phase2.policies[currentYear] ? gameStateData.phase2.policies[currentYear][playerCountry] : null;
            const allSubmitted = Object.keys(gameStateData.players).every(pid => {
              const player = gameStateData.players[pid];
              return gameStateData.phase2.policies[currentYear] && gameStateData.phase2.policies[currentYear][player.country];
            });

            const submitPolicies = (e) => {
              e.preventDefault();
              const formData = new FormData(e.target);
              const centralBankRate = formData.get('centralBankRate');
              const exchangeRate = formData.get('exchangeRate');
              const tariffRate = formData.get('tariffRate');
              
              socket.emit('setPhase2Policies', {
                playerId,
                centralBankRate: parseFloat(centralBankRate),
                exchangeRate: parseFloat(exchangeRate),
                tariffRate: parseFloat(tariffRate)
              });
            };

            const advanceYear = () => {
              socket.emit('advanceYear');
            };

            return (
              <div className="container">
                <UserDisplay />
                <ConnectionStatus />
                <div className="header">
                  <h1>üìä Post-War Economic Management</h1>
                  <p>Phase 2: Year {currentYear} of 1946-1952</p>
                </div>

                <div className="card">
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px' }}>
                    <div>
                      <h2 style={{ fontSize: '1.5rem', color: '#1e293b', marginBottom: '8px' }}>
                        Year {currentYear} ({currentYear - 1945} of 7)
                      </h2>
                      <p style={{ color: '#64748b', fontSize: '0.9rem' }}>
                        Playing as: <span style={{ fontWeight: 'bold', color: '#3b82f6' }}>{countries[playerCountry].name}</span>
                      </p>
                    </div>
                    <div style={{ textAlign: 'right' }}>
                      <div style={{ fontSize: '0.875rem', color: '#64748b' }}>Phase 1 Score</div>
                      <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#16a34a' }}>
                        {gameStateData.scores[playerCountry]} pts
                      </div>
                    </div>
                  </div>

                  {myCountryData && (
                    <div style={{ marginBottom: '30px' }}>
                      <h3 style={{ fontSize: '1.125rem', marginBottom: '16px' }}>üìà Economic Dashboard</h3>
                      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px' }}>
                        <div style={{ padding: '16px', background: '#f0f9ff', borderRadius: '8px', border: '1px solid #bae6fd' }}>
                          <div style={{ fontSize: '0.875rem', color: '#0369a1', marginBottom: '4px' }}>GDP Growth</div>
                          <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#0c4a6e' }}>
                            {myCountryData.gdpGrowth ? myCountryData.gdpGrowth.toFixed(1) : '0.0'}%
                          </div>
                        </div>
                        <div style={{ padding: '16px', background: '#fef3c7', borderRadius: '8px', border: '1px solid #fde047' }}>
                          <div style={{ fontSize: '0.875rem', color: '#a16207', marginBottom: '4px' }}>Unemployment</div>
                          <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#78350f' }}>
                            {myCountryData.unemployment ? myCountryData.unemployment.toFixed(1) : '0.0'}%
                          </div>
                        </div>
                        <div style={{ padding: '16px', background: '#fee2e2', borderRadius: '8px', border: '1px solid #fca5a5' }}>
                          <div style={{ fontSize: '0.875rem', color: '#b91c1c', marginBottom: '4px' }}>Inflation</div>
                          <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#7f1d1d' }}>
                            {myCountryData.inflation ? myCountryData.inflation.toFixed(1) : '0.0'}%
                          </div>
                        </div>
                        <div style={{ padding: '16px', background: '#dcfce7', borderRadius: '8px', border: '1px solid #86efac' }}>
                          <div style={{ fontSize: '0.875rem', color: '#15803d', marginBottom: '4px' }}>Trade Balance</div>
                          <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#14532d' }}>
                            ${myCountryData.tradeBalance ? (myCountryData.tradeBalance / 1000).toFixed(1) : '0.0'}B
                          </div>
                        </div>
                        <div style={{ padding: '16px', background: '#fef3c7', borderRadius: '8px', border: '1px solid #fde047' }}>
                          <div style={{ fontSize: '0.875rem', color: '#a16207', marginBottom: '4px' }}>Gold Reserves</div>
                          <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#78350f' }}>
                            ${myCountryData.goldReserves ? (myCountryData.goldReserves / 1000).toFixed(1) : '0.0'}B
                          </div>
                        </div>
                        <div style={{ padding: '16px', background: '#e0e7ff', borderRadius: '8px', border: '1px solid #c7d2fe' }}>
                          <div style={{ fontSize: '0.875rem', color: '#4338ca', marginBottom: '4px' }}>Industrial Output</div>
                          <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#312e81' }}>
                            {myCountryData.industrialOutput ? myCountryData.industrialOutput.toFixed(0) : '0'}
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {!myPolicies ? (
                    <div style={{ marginBottom: '30px' }}>
                      <h3 style={{ fontSize: '1.125rem', marginBottom: '16px' }}>‚öôÔ∏è Set Economic Policies for {currentYear}</h3>
                      <p style={{ color: '#64748b', fontSize: '0.9rem', marginBottom: '20px' }}>
                        Choose your macroeconomic policies carefully. They will affect growth, unemployment, inflation, and trade.
                      </p>

                      <form onSubmit={submitPolicies}>
                        <div style={{ display: 'grid', gap: '24px', maxWidth: '600px', margin: '0 auto' }}>
                          
                          {/* Central Bank Rate */}
                          <div style={{ padding: '20px', background: '#f8fafc', borderRadius: '8px' }}>
                            <label style={{ display: 'block', fontWeight: 'bold', marginBottom: '12px' }}>
                              üè¶ Central Bank Interest Rate
                            </label>
                            <p style={{ fontSize: '0.875rem', color: '#64748b', marginBottom: '12px' }}>
                              Lower rates stimulate growth but risk inflation. Higher rates control inflation but slow growth.
                            </p>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                              <input
                                type="range"
                                name="centralBankRate"
                                min="0"
                                max="10"
                                step="0.5"
                                defaultValue="3"
                                style={{ flex: 1 }}
                                onInput={(e) => e.target.nextElementSibling.textContent = e.target.value + '%'}
                              />
                              <span style={{ minWidth: '60px', fontWeight: 'bold', fontSize: '1.125rem' }}>3%</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.75rem', color: '#94a3b8', marginTop: '4px' }}>
                              <span>0% (Loose)</span>
                              <span>5% (Optimal)</span>
                              <span>10% (Tight)</span>
                            </div>
                          </div>

                          {/* Exchange Rate */}
                          <div style={{ padding: '20px', background: '#f8fafc', borderRadius: '8px' }}>
                            <label style={{ display: 'block', fontWeight: 'bold', marginBottom: '12px' }}>
                              üí± Exchange Rate vs USD
                            </label>
                            <p style={{ fontSize: '0.875rem', color: '#64748b', marginBottom: '12px' }}>
                              Weak currency helps exports. Strong currency helps imports. Balance is key.
                            </p>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                              <input
                                type="range"
                                name="exchangeRate"
                                min="0.5"
                                max="2.0"
                                step="0.1"
                                defaultValue="1.0"
                                style={{ flex: 1 }}
                                onInput={(e) => e.target.nextElementSibling.textContent = e.target.value}
                              />
                              <span style={{ minWidth: '60px', fontWeight: 'bold', fontSize: '1.125rem' }}>1.0</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.75rem', color: '#94a3b8', marginTop: '4px' }}>
                              <span>0.5 (Weak)</span>
                              <span>1.0 (Parity)</span>
                              <span>2.0 (Strong)</span>
                            </div>
                          </div>

                          {/* Tariff Rate */}
                          <div style={{ padding: '20px', background: '#f8fafc', borderRadius: '8px' }}>
                            <label style={{ display: 'block', fontWeight: 'bold', marginBottom: '12px' }}>
                              üì¶ Average Tariff Rate
                            </label>
                            <p style={{ fontSize: '0.875rem', color: '#64748b', marginBottom: '12px' }}>
                              High tariffs protect domestic industry but reduce trade. Low tariffs increase efficiency.
                            </p>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                              <input
                                type="range"
                                name="tariffRate"
                                min="0"
                                max="50"
                                step="5"
                                defaultValue="10"
                                style={{ flex: 1 }}
                                onInput={(e) => e.target.nextElementSibling.textContent = e.target.value + '%'}
                              />
                              <span style={{ minWidth: '60px', fontWeight: 'bold', fontSize: '1.125rem' }}>10%</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.75rem', color: '#94a3b8', marginTop: '4px' }}>
                              <span>0% (Free Trade)</span>
                              <span>25% (Moderate)</span>
                              <span>50% (Protectionist)</span>
                            </div>
                          </div>
                        </div>

                        <div style={{ textAlign: 'center', marginTop: '30px' }}>
                          <button type="submit" className="btn-primary" style={{ fontSize: '1.125rem', padding: '14px 32px' }}>
                            üìã Submit Economic Policies
                          </button>
                        </div>
                      </form>
                    </div>
                  ) : (
                    <div style={{ marginBottom: '30px' }}>
                      <div style={{ padding: '20px', background: '#dcfce7', borderRadius: '8px', marginBottom: '20px', border: '1px solid #86efac' }}>
                        <h3 style={{ fontSize: '1.125rem', color: '#15803d', marginBottom: '12px' }}>
                          ‚úÖ Your Policies Submitted for {currentYear}
                        </h3>
                        <div style={{ display: 'grid', gap: '12px' }}>
                          <div>
                            <span style={{ color: '#64748b' }}>Central Bank Rate:</span>{' '}
                            <span style={{ fontWeight: 'bold' }}>{myPolicies.centralBankRate}%</span>
                          </div>
                          <div>
                            <span style={{ color: '#64748b' }}>Exchange Rate:</span>{' '}
                            <span style={{ fontWeight: 'bold' }}>{myPolicies.exchangeRate}</span>
                          </div>
                          <div>
                            <span style={{ color: '#64748b' }}>Tariff Rate:</span>{' '}
                            <span style={{ fontWeight: 'bold' }}>{myPolicies.tariffRate}%</span>
                          </div>
                        </div>
                      </div>

                      <div style={{ textAlign: 'center' }}>
                        <p style={{ color: '#64748b', marginBottom: '16px' }}>
                          ‚è≥ Waiting for other countries to submit their policies...
                        </p>
                        <p style={{ fontSize: '0.875rem', color: '#94a3b8' }}>
                          {Object.keys(gameStateData.players).filter(pid => {
                            const player = gameStateData.players[pid];
                            return gameStateData.phase2.policies[currentYear] && gameStateData.phase2.policies[currentYear][player.country];
                          }).length} / {Object.keys(gameStateData.players).length} submitted
                        </p>

                        {allSubmitted && (
                          <button className="btn-success" onClick={advanceYear} style={{ marginTop: '20px', fontSize: '1.125rem', padding: '14px 32px' }}>
                            üìä Calculate Year Results & Continue
                          </button>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Historical Data */}
                  {Object.keys(gameStateData.phase2.yearlyData).length > 1 && (
                    <div style={{ marginTop: '30px', paddingTop: '30px', borderTop: '2px solid #e2e8f0' }}>
                      <h3 style={{ fontSize: '1.125rem', marginBottom: '16px' }}>üìú Historical Performance</h3>
                      <div style={{ overflowX: 'auto' }}>
                        <table style={{ width: '100%', fontSize: '0.875rem', borderCollapse: 'collapse' }}>
                          <thead>
                            <tr style={{ background: '#f8fafc', borderBottom: '2px solid #cbd5e1' }}>
                              <th style={{ padding: '8px', textAlign: 'left' }}>Year</th>
                              <th style={{ padding: '8px', textAlign: 'right' }}>GDP</th>
                              <th style={{ padding: '8px', textAlign: 'right' }}>Unemp</th>
                              <th style={{ padding: '8px', textAlign: 'right' }}>Inflation</th>
                              <th style={{ padding: '8px', textAlign: 'right' }}>Trade</th>
                              <th style={{ padding: '8px', textAlign: 'right' }}>Gold</th>
                            </tr>
                          </thead>
                          <tbody>
                            {Object.keys(gameStateData.phase2.yearlyData).sort().map(year => {
                              const data = gameStateData.phase2.yearlyData[year][playerCountry];
                              if (!data) return null;
                              return (
                                <tr key={year} style={{ borderBottom: '1px solid #e2e8f0' }}>
                                  <td style={{ padding: '8px', fontWeight: 'bold' }}>{year}</td>
                                  <td style={{ padding: '8px', textAlign: 'right' }}>{data.gdpGrowth ? data.gdpGrowth.toFixed(1) + '%' : '-'}</td>
                                  <td style={{ padding: '8px', textAlign: 'right' }}>{data.unemployment ? data.unemployment.toFixed(1) + '%' : '-'}</td>
                                  <td style={{ padding: '8px', textAlign: 'right' }}>{data.inflation ? data.inflation.toFixed(1) + '%' : '-'}</td>
                                  <td style={{ padding: '8px', textAlign: 'right' }}>${data.tradeBalance ? (data.tradeBalance / 1000).toFixed(1) : '0.0'}B</td>
                                  <td style={{ padding: '8px', textAlign: 'right' }}>${data.goldReserves ? (data.goldReserves / 1000).toFixed(1) : '0.0'}B</td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            );
          }

          // Game Complete
          if (gameStateData.gamePhase === 'complete') {
            const sortedScores = Object.entries(gameStateData.scores).sort((a, b) => b[1] - a[1]);
            const winner = sortedScores[0];

            return (
              <div className="container">
                <ConnectionStatus />
                <div className="header">
                  <h1>üèÜ Conference Results</h1>
                  <p>Final Outcomes</p>
                </div>

                <div className="card">
                  <h2 style={{ textAlign: 'center', marginBottom: '20px' }}>
                    {countries[winner[0]].name} Wins!
                  </h2>

                  <div className="final-scores">
                    {sortedScores.map(([country, score]) => (
                      <div key={country} className={`score-card ${countries[country].color}`}>
                        <h3>{countries[country].name}</h3>
                        <div className="score-value">{score}</div>
                      </div>
                    ))}
                  </div>

                  <div style={{ textAlign: 'center' }}>
                    <button className="btn-primary" onClick={resetGame}>üîÑ Play Again</button>
                  </div>
                </div>
              </div>
            );
          }

          // Voting Screen
          if (!playerCountry) {
            return (
              <div className="container">
                <ConnectionStatus />
                <div className="card">
                  <h3 style={{ textAlign: 'center', color: '#dc2626', marginBottom: '20px' }}>
                    ‚ö†Ô∏è You Are Not in the Game
                  </h3>
                  <p style={{ textAlign: 'center', color: '#64748b', marginBottom: '30px' }}>
                    Please wait for the game to reset or refresh to rejoin.
                  </p>
                  <div style={{ textAlign: 'center' }}>
                    <button className="btn-secondary" onClick={() => window.location.reload()}>
                      üîÑ Refresh Page
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          const myCountry = countries[playerCountry];
          const myVoteKey = `${currentIssue.id}-${playerCountry}`;
          const myVote = gameStateData.votes[myVoteKey];
          const allVotesIn = Object.keys(gameStateData.players).every(pid => {
            const p = gameStateData.players[pid];
            const voteKey = `${currentIssue.id}-${p.country}`;
            return gameStateData.votes[voteKey] !== undefined;
          });

          return (
            <div className="container">
              <ConnectionStatus />
              <div className="header">
                <h1>üåç Bretton Woods Conference</h1>
                <p>Round {gameStateData.currentRound} of {issues.length}</p>
              </div>

              <div className="card" style={{ marginBottom: '20px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap', gap: '16px' }}>
                  <div>
                    <h3 className={myCountry.textColor} style={{ fontSize: '1.25rem', marginBottom: '4px' }}>
                      {myCountry.name}
                    </h3>
                    <p style={{ color: '#64748b', fontSize: '0.875rem' }}>
                      Score: {gameStateData.scores[playerCountry]} points
                    </p>
                  </div>
                  <div>
                    <button className="btn-secondary" onClick={() => setShowEconomics(!showEconomics)}>
                      {showEconomics ? 'Hide' : 'Show'} Economic Data
                    </button>
                  </div>
                </div>
              </div>

              {showEconomics && (
                <div className="card">
                  <h3 style={{ marginBottom: '20px' }}>Economic Position - 1944</h3>
                  <div className="economic-grid">
                    <div className="economic-card">
                      <h4>Gold Reserves</h4>
                      <p>${economicData[playerCountry].goldReserves}M</p>
                    </div>
                    <div className="economic-card">
                      <h4>GDP</h4>
                      <p>${economicData[playerCountry].gdp}M</p>
                    </div>
                    <div className="economic-card">
                      <h4>War Debt</h4>
                      <p>${economicData[playerCountry].warDebt}M</p>
                    </div>
                  </div>
                </div>
              )}

              <div className="card">
                <h2>{currentIssue.title}</h2>
                <p style={{ color: '#64748b', margin: '16px 0' }}>{currentIssue.description}</p>

                <div style={{ marginTop: '20px' }}>
                  <h3 style={{ marginBottom: '16px', fontSize: '1.125rem' }}>Options:</h3>
                  {currentIssue.options.map((option, idx) => {
                    const favorsYou = option.favors.includes(playerCountry);
                    const opposesYou = option.opposes.includes(playerCountry);
                    const isSelected = myVote === option.id;
                    
                    return (
                      <div 
                        key={option.id} 
                        onClick={() => myVote === undefined && submitVote(currentIssue.id, option.id)}
                        style={{ 
                          padding: '16px', 
                          background: isSelected ? '#3b82f6' : (favorsYou ? '#dcfce7' : opposesYou ? '#fee2e2' : '#f8fafc'),
                          borderRadius: '8px',
                          marginBottom: '12px',
                          borderLeft: '4px solid ' + (isSelected ? '#1e40af' : favorsYou ? '#16a34a' : opposesYou ? '#dc2626' : '#3b82f6'),
                          cursor: myVote === undefined ? 'pointer' : 'default',
                          transition: 'all 0.2s',
                          color: isSelected ? 'white' : 'inherit'
                        }}
                      >
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                          <div style={{ flex: 1 }}>
                            <strong style={{ fontSize: '1.125rem' }}>{String.fromCharCode(65 + idx)}.</strong> {option.text}
                          </div>
                          <div style={{ display: 'flex', gap: '8px', alignItems: 'center', marginLeft: '16px' }}>
                            {isSelected && <span style={{ fontWeight: 'bold' }}>‚úì SELECTED</span>}
                            {!isSelected && favorsYou && <span style={{ color: '#16a34a', fontSize: '0.875rem' }}>‚úì Favors (+10)</span>}
                            {!isSelected && opposesYou && <span style={{ color: '#dc2626', fontSize: '0.875rem' }}>‚úó Opposes (-5)</span>}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>

                <div style={{ marginTop: '30px', padding: '20px', background: '#f8fafc', borderRadius: '8px', textAlign: 'center' }}>
                  {myVote === undefined ? (
                    <p style={{ color: '#64748b' }}>
                      üëÜ Click on an option above to cast your vote
                    </p>
                  ) : (
                    <div>
                      <p style={{ fontSize: '1.125rem', color: '#16a34a', fontWeight: 'bold', marginBottom: '12px' }}>
                        ‚úì Vote Cast for Option {String.fromCharCode(65 + currentIssue.options.findIndex(o => o.id === myVote))}
                      </p>
                      <button className="btn-secondary" onClick={() => submitVote(currentIssue.id, undefined)}>
                        Change Vote
                      </button>
                    </div>
                  )}
                </div>

                {myVote !== undefined && !allVotesIn && (
                  <div style={{ marginTop: '20px', padding: '16px', background: '#fef3c7', borderRadius: '8px', textAlign: 'center' }}>
                    <p style={{ color: '#92400e' }}>
                      ‚è≥ Waiting for other players... ({Object.keys(gameStateData.players).filter(id => {
                        const p = gameStateData.players[id];
                        const vk = `${currentIssue.id}-${p.country}`;
                        return gameStateData.votes[vk] !== undefined;
                      }).length} / {Object.keys(gameStateData.players).length} voted)
                    </p>
                  </div>
                )}

                {allVotesIn && (
                  <div style={{ marginTop: '20px' }}>
                    <div style={{ marginBottom: '16px', padding: '16px', background: '#dcfce7', borderRadius: '8px' }}>
                      <p style={{ color: '#166534', textAlign: 'center', fontWeight: 'bold', marginBottom: '12px' }}>
                        ‚úì All players voted!
                      </p>
                      {(() => {
                        const voteCounts = {};
                        currentIssue.options.forEach(opt => voteCounts[opt.id] = 0);
                        
                        Object.keys(gameStateData.players).forEach(pid => {
                          const p = gameStateData.players[pid];
                          const vk = `${currentIssue.id}-${p.country}`;
                          const vote = gameStateData.votes[vk];
                          if (vote) voteCounts[vote]++;
                        });
                        
                        let winningId = null;
                        let maxVotes = -1;
                        Object.entries(voteCounts).forEach(([optId, count]) => {
                          if (count > maxVotes) {
                            maxVotes = count;
                            winningId = optId;
                          }
                        });
                        
                        const winningOption = currentIssue.options.find(o => o.id === winningId);
                        
                        return (
                          <div style={{ marginTop: '12px' }}>
                            <p style={{ color: '#166534', fontSize: '0.875rem', textAlign: 'center' }}>
                              <strong>Vote Results:</strong>
                            </p>
                            {currentIssue.options.map((opt, idx) => (
                              <p key={opt.id} style={{ 
                                color: opt.id === winningId ? '#166534' : '#64748b',
                                fontSize: '0.875rem',
                                textAlign: 'center',
                                fontWeight: opt.id === winningId ? 'bold' : 'normal'
                              }}>
                                {opt.id === winningId ? 'üèÜ ' : ''}
                                Option {String.fromCharCode(65 + idx)}: {voteCounts[opt.id]} vote{voteCounts[opt.id] !== 1 ? 's' : ''}
                                {opt.id === winningId ? ' - WINNER!' : ''}
                              </p>
                            ))}
                            {winningOption && (
                              <div style={{ marginTop: '12px', padding: '12px', background: '#f0fdf4', borderRadius: '6px' }}>
                                <p style={{ fontSize: '0.875rem', color: '#166534' }}>
                                  <strong>Adopted Policy:</strong> {winningOption.text}
                                </p>
                              </div>
                            )}
                          </div>
                        );
                      })()}
                    </div>
                    
                    <div style={{ textAlign: 'center' }}>
                      <button className={isReady ? 'btn-success' : 'btn-primary'} onClick={toggleReady} style={{ marginRight: '12px' }}>
                        {isReady ? '‚úì Ready' : 'Mark Ready'}
                      </button>
                      
                      {gameStateData.readyPlayers.length === Object.keys(gameStateData.players).length && (
                        <button className="btn-success" onClick={advanceRound}>
                          {gameStateData.currentRound < issues.length ? 'Next Round ‚Üí' : 'See Results'}
                        </button>
                      )}
                    </div>
                    
                    <p style={{ textAlign: 'center', marginTop: '12px', fontSize: '0.875rem', color: '#64748b' }}>
                      {gameStateData.readyPlayers.length} / {Object.keys(gameStateData.players).length} ready
                    </p>
                  </div>
                )}
              </div>
            </div>
          );
        };

        function initializeApp() {
          ReactDOM.render(<BrettonWoodsMultiplayer />, document.getElementById('root'));
        }
    </script>
</body>
</html>
